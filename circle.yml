machine:
  java:
    version:
      oraclejdk7

dependencies:
  override:
    # Prepare the build for release if necessary
    - mkdir -p ~/build-common
    - curl -L https://smartthings-provisioning.s3.amazonaws.com/build-common/build-common.tar.gz | tar xvz -C ~/build-common
    - sudo pip install -r ~/build-common/requirements.txt
    - ~/build-common/circle-ci/update_version.py --branch=release

    # Load dependencies into the cache
    - ./gradlew classes testClasses -PsmartThingsArtifactoryUserName=$ARTIFACTORY_USERNAME -PsmartThingsArtifactoryPassword=$ARTIFACTORY_PASSWORD

test:
  override:
    - ./gradlew check -PsmartThingsArtifactoryUserName=$ARTIFACTORY_USERNAME -PsmartThingsArtifactoryPassword=$ARTIFACTORY_PASSWORD
  post:
    - cp build/test-results/*.xml $CIRCLE_TEST_REPORTS/ || true

deployment:
  snapshot:
    branch: master
    commands:
      - ./gradlew publish -PsmartThingsArtifactoryUserName=$ARTIFACTORY_USERNAME -PsmartThingsArtifactoryPassword=$ARTIFACTORY_PASSWORD

  release:
    branch: release
    commands:
      - ./gradlew zipDependencies -PsmartThingsArtifactoryUserName=$ARTIFACTORY_USERNAME -PsmartThingsArtifactoryPassword=$ARTIFACTORY_PASSWORD
      - ./gradlew publish -PsmartThingsArtifactoryUserName=$ARTIFACTORY_USERNAME -PsmartThingsArtifactoryPassword=$ARTIFACTORY_PASSWORD
      - ~/build-common/circle-ci/s3_upload.py --branch=release --artifact=st-slf4j/build/distributions/st-slf4j-$(cat version.txt).zip --buckets='smartthings-provisioning' --remotepath='packages/logging'
      - ~/build-common/circle-ci/release.py --branch=release
